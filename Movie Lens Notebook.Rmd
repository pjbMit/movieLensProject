---
title: "Machine Learning Harvard Capstone Movie Lens Project R Notebook"
output: html_notebook
---

### Machine Learning Harvard Capstone Movie Lens Project R Notebook

June 2019

This is my Move Lens project for the Capstone Course in the HarvardX Data Science Certificate Program.

Student: Philip Brown
email: Phil@pjb3.com
github: https://github.com/pjbMit

The project was created in the RStudio environment 
using Rstudio Version 1.1.442 
on a Macintosh; Intel Mac OS X 10_14_5

R version 3.5.1 (2018-07-02)  
nickname       Feather Spray

See the README.Rmd or README.html files for more information on the environment and setup.

For questions, email me:   pjbMit@pjb3.com  , and I'll gladly respond promptly.


---------------------------
1) Develop your algorithm using the edx set. 

2) For a final test of your algorithm, predict movie ratings in the validation set as if they were unknown.

3) RMSE will be used to evaluate how close your predictions are to the true values in the validation set.


## Set up.

Data is downloaded from  https://grouplens.org/datasets/movielens/10m/

and then a subset is selected by running this code which is given in the assignment's instructions:

Data setup

I needed to make two basic changes:
First) I needed to use a different repository to load the libraries, because repo specified didn't work on my mac.
Second) This R Code crashed RStudio repeatedly, so I created a function and added code to save objects as files,
        so that I could save intermediate results into a file, and then reload them if and as necessary if R crashed.
With these two work-arounds, I was able to load and process all of the data without incident.
```{r}

###################################
# Create edx set and validation set
###################################

# Note: this process could take a couple of minutes

# PJB - Changed repo to a parameter so that I can use a compatible repo on my mac.
isMac <- TRUE
#isMac <- FALSE  ##Set to false if you are NOT running on a Mac.

# Create a bunch of file names in my directory to save intermediate results to files
t1 <- "~/movieLens1.rds"
t2 <- "~/movieLens2.rds"
t3 <- "~/movieLens3.rds"
t4 <- "~/movieLens4.rds"
t5 <- "~/movieLens5.rds"
t6 <- "~/movieLens6.rds"
t7 <- "~/movieLens7.rds"
t8 <- "~/movieLens8.rds"
t9 <- "~/movieLens9.rds"
t10 <- "~/movieLens10.rds"
edxFile <- "~/edxFile.rds"
validationFile <- "~/validationFile.rds"
fileName <- "movieLensSetup.rds"

#Function that if passed save==TRUE with save the object to the file.
#  otherwise returns without doing anything
#  This function was  created to save intermediate results to the file system,
#  because for some reason RStudio crashed repeatedly when I tried to run the whole script.
#  using code of the form:
#        objectName <- load(file)
#  if RStudio crashes, you can reload the objects already processed, and then
#  continue the scrit from there.
saveWork <- function(file,object,save){
    if(save){
        saveRDS(object,file)
    }
}

ifelse(isMac,repo <- "https://cran.revolutionanalytics.com/" , repo <- "http://cran.us.r-project.org")
repo
# 

if(!require(tidyverse)) install.packages("tidyverse", repos = repo)
if(!require(caret)) install.packages("caret", repos = repo)

library(tidyverse)
library(caret)
# MovieLens 10M dataset:
# https://grouplens.org/datasets/movielens/10m/
# http://files.grouplens.org/datasets/movielens/ml-10m.zip

dl <- tempfile()
download.file("http://files.grouplens.org/datasets/movielens/ml-10m.zip", dl)

dl
ratings <- read.table(text = gsub("::", "\t", readLines(unzip(dl, "ml-10M100K/ratings.dat"))),
                      col.names = c("userId", "movieId", "rating", "timestamp"))

## Set saveProgess to TRUE to save objects as intermediate results to files
## set it to FALSE not to save the intermediate results to files.
## This is used because RSTUDIO crashed repeatedly when I ran the script, 
## so this allowed me to save intermediate results into files, and reload them later
## to continue processing.
saveProgress <- TRUE
#saveProgress <- FALSE  

saveWork(t1,ratings,saveProgress)

movies <- str_split_fixed(readLines(unzip(dl, "ml-10M100K/movies.dat")), "\\::", 3)
colnames(movies) <- c("movieId", "title", "genres")
movies <- as.data.frame(movies) %>% mutate(movieId = as.numeric(levels(movieId))[movieId],
                                           title = as.character(title),
                                           genres = as.character(genres))
saveWork(t2,movies,saveProgress)

movielens <- left_join(ratings, movies, by = "movieId")
saveWork(t3,movielens,saveProgress)

# Validation set will be 10% of MovieLens data

set.seed(1) # if using R 3.6.0: set.seed(1, sample.kind = "Rounding")
test_index <- createDataPartition(y = movielens$rating, times = 1, p = 0.1, list = FALSE)
edx <- movielens[-test_index,]
temp <- movielens[test_index,]

saveWork(t4,test_index,saveProgress)
saveWork(t5,edx,saveProgress)
saveWork(t6,temp,saveProgress)

# Make sure userId and movieId in validation set are also in edx set

validation <- temp %>% 
     semi_join(edx, by = "movieId") %>%
     semi_join(edx, by = "userId")
saveWork(t7,validation,saveProgress)

# Add rows removed from validation set back into edx set

removed <- anti_join(temp, validation)
saveWork(t8,removed,saveProgress)

edx <- rbind(edx, removed)


rm(dl, ratings, movies, test_index, temp, movielens, removed)

#Save these two objects into files, so that I can easily 
#recreate the object using code similar to:
#    objectName <- load(file)
#without having to download and process the data again.
saveWork(edxFile,edx,saveProgress)
saveWork(validationFile,validation,saveProgress)

#Clean up my environment by removing old variables.
rm(t1,t2,t3,t4,t5,t6,t7,t8,t9,t10,fileName,isMac,repo)

```

## Note: Because I had to run the code line-by-line, the output doesn't show up in the output file produced by the RMD.
## Please don't penalize me for this side effect of RSTUDIO crashing when I ran the whole script at once.


Now the edx object and the validation object are both saved on the file system, so as a short-cut I can reload
those objects from disk to run my code, rather than having to download and process the raw data multiple times
during development.

```{r}

require(tidyverse)
require(caret)
restoreEdx <- function(){
    edxFile <- "~/edxFile.rds"
    edx <- readRDS(edxFile)
    edx
}
restoreValidation <- function(){
    validationFile <- "~/validationFile.rds"
    validation <- readRDS(validationFile)
    validation
    
}

#edx <- restoreEdx()
#validation <- restoreValidation()


```

